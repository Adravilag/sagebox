<!doctype html>
<html lang="es" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vanilla JS - Event Editor Example</title>
    <style>
      /* Ocultar contenido de modales hasta que se hidraten */
      sg-modal:not(:defined) {
        display: none;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #ffffff;
        --surface: #f4f4f5;
        --text: #18181b;
        --text-muted: #71717a;
        --border: #e4e4e7;
        --accent: #6366f1;
      }

      [data-theme='dark'] {
        --bg: #09090b;
        --surface: #18181b;
        --text: #f4f4f5;
        --text-muted: #a1a1aa;
        --border: #27272a;
      }

      body {
        font-family: 'Inter', system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        padding: 2rem;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        background: var(--surface);
        border-radius: 9999px;
        color: var(--text-muted);
      }

      .section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .section-title {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .demo-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .output {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.875rem;
        color: var(--text-muted);
        min-height: 60px;
      }

      .output.highlight {
        border-color: var(--accent);
        color: var(--accent);
      }

      /* Status indicator */
      .status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-muted);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #22c55e;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Form example */
      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      /* Card grid */
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }
    </style>

    <!-- SageBox Components (versi√≥n local) -->
    <script type="module" src="../../../../www/build/sagebox.esm.js"></script>
    <link rel="stylesheet" href="../../../../www/build/sagebox.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üß™ Event Editor - Demo Vanilla JS</h1>
        <div class="status">
          <span class="status-dot"></span>
          <span>Conectado al Event Editor</span>
        </div>
      </header>

      <!-- Buttons Section -->
      <div class="section">
        <h2 class="section-title">Botones</h2>
        <div class="demo-row">
          <sg-button id="btn-primary" variant="primary">Primary</sg-button>
          <sg-button id="btn-secondary" variant="secondary">Secondary</sg-button>
          <sg-button id="btn-success" variant="success">Success</sg-button>
          <sg-button id="btn-warning" variant="warning">Warning</sg-button>
          <sg-button id="btn-error" variant="error">Error</sg-button>
          <sg-button id="btn-ghost" variant="ghost">Ghost</sg-button>
        </div>
        <div class="output" id="button-output">Haz click en un bot√≥n...</div>
      </div>

      <!-- Dropdown Section -->
      <div class="section">
        <h2 class="section-title">Dropdown</h2>
        <div class="demo-row">
          <sg-dropdown id="dropdown-menu">
            <sg-button slot="trigger" variant="outline">
              Abrir men√∫
              <span style="margin-left: 4px">‚ñæ</span>
            </sg-button>
            <div style="padding: 8px">
              <button class="dropdown-item" style="display: block; width: 100%; padding: 8px 12px; text-align: left; background: none; border: none; cursor: pointer">
                Opci√≥n 1
              </button>
              <button class="dropdown-item" style="display: block; width: 100%; padding: 8px 12px; text-align: left; background: none; border: none; cursor: pointer">
                Opci√≥n 2
              </button>
              <button class="dropdown-item" style="display: block; width: 100%; padding: 8px 12px; text-align: left; background: none; border: none; cursor: pointer">
                Opci√≥n 3
              </button>
            </div>
          </sg-dropdown>
        </div>
        <div class="output" id="dropdown-output">Abre el dropdown...</div>
      </div>

      <!-- Modal Section -->
      <div class="section">
        <h2 class="section-title">Modal</h2>
        <div class="demo-row">
          <sg-button id="open-modal-btn" variant="primary">Abrir Modal</sg-button>
          <sg-button id="open-modal-confirm" variant="warning">Modal de Confirmaci√≥n</sg-button>
        </div>
        <div class="output" id="modal-output">Abre un modal...</div>
      </div>

      <sg-modal id="demo-modal" header="Modal de Ejemplo">
        <p style="margin-bottom: 1rem">Este es un modal de ejemplo para probar los eventos.</p>
        <p style="color: var(--text-muted); font-size: 0.875rem">Puedes cerrar con ESC, click en backdrop o el bot√≥n.</p>
        <div slot="footer" style="display: flex; gap: 8px; justify-content: flex-end">
          <sg-button variant="secondary" onclick="document.getElementById('demo-modal').close()">Cancelar</sg-button>
          <sg-button variant="primary" onclick="document.getElementById('demo-modal').close('confirmed')">Aceptar</sg-button>
        </div>
      </sg-modal>

      <sg-modal id="confirm-modal" header="¬øEst√°s seguro?" size="sm">
        <p>Esta acci√≥n no se puede deshacer.</p>
        <div slot="footer" style="display: flex; gap: 8px; justify-content: flex-end">
          <sg-button variant="secondary" onclick="document.getElementById('confirm-modal').close()">No</sg-button>
          <sg-button variant="error" onclick="document.getElementById('confirm-modal').close('delete')">S√≠, eliminar</sg-button>
        </div>
      </sg-modal>

      <!-- Input Section -->
      <div class="section">
        <h2 class="section-title">Inputs</h2>
        <div class="form-group">
          <label for="input-text">Texto</label>
          <sg-input id="input-text" placeholder="Escribe algo..."></sg-input>
        </div>
        <div class="form-group">
          <label for="input-search">B√∫squeda</label>
          <sg-input id="input-search" type="search" placeholder="Buscar..."></sg-input>
        </div>
        <div class="output" id="input-output">Escribe en un input...</div>
      </div>

      <!-- Theme Toggle -->
      <div class="section">
        <h2 class="section-title">Theme Toggle</h2>
        <div class="demo-row">
          <sg-theme-toggle id="theme-toggle"></sg-theme-toggle>
          <span style="color: var(--text-muted); font-size: 0.875rem">Cambia entre modo claro y oscuro</span>
        </div>
      </div>

      <!-- Cards Section -->
      <div class="section">
        <h2 class="section-title">Cards</h2>
        <div class="card-grid">
          <sg-card id="card-1">
            <div slot="header">Card 1</div>
            <p>Contenido de ejemplo para la primera card.</p>
          </sg-card>
          <sg-card id="card-2">
            <div slot="header">Card 2</div>
            <p>Contenido de ejemplo para la segunda card.</p>
          </sg-card>
          <sg-card id="card-3">
            <div slot="header">Card 3</div>
            <p>Contenido de ejemplo para la tercera card.</p>
          </sg-card>
        </div>
      </div>
    </div>

    <script>
      // =========================================================================
      // Event Editor Communication Bridge
      // =========================================================================

      // Notify Event Editor that we're ready
      function notifyEventEditor(type, payload) {
        if (window.parent !== window) {
          window.parent.postMessage({ type, payload }, '*');
        }
      }

      // Scan and report SageBox components to Event Editor
      function reportComponents() {
        const componentMap = new Map();

        document.querySelectorAll('*').forEach(el => {
          const tag = el.tagName.toLowerCase();
          if (tag.startsWith('sg-')) {
            const existing = componentMap.get(tag) || { count: 0, ids: [] };
            existing.count++;
            if (el.id) existing.ids.push(el.id);
            componentMap.set(tag, existing);
          }
        });

        const components = Array.from(componentMap.entries()).map(([name, info]) => ({
          name,
          count: info.count,
          ids: info.ids,
        }));

        window.parent?.postMessage(
          {
            type: 'event-editor:components-list',
            components,
          },
          '*',
        );
      }

      // Report components when page loads
      window.addEventListener('DOMContentLoaded', () => {
        // Wait for web components to be defined
        customElements
          .whenDefined('sg-button')
          .then(reportComponents)
          .catch(() => {
            // Fallback: report after a short delay
            setTimeout(reportComponents, 1000);
          });
      });

      // Respond to ping from Event Editor
      window.addEventListener('message', e => {
        if (e.data.type === 'ping') {
          notifyEventEditor('pong', {});
        }
        if (e.data.type === 'toggle-inspect') {
          document.body.classList.toggle('inspect-mode', e.data.enabled);
        }
        if (e.data.type === 'request-components') {
          reportComponents();
        }
        // Handle rule injection from Event Editor
        if (e.data.type === 'event-editor:inject-rules') {
          injectRulesCode(e.data.code);
        }
        if (e.data.type === 'event-editor:clear-rules') {
          clearInjectedRules();
        }
      });

      // =========================================================================
      // Rule Injection System
      // =========================================================================

      let injectedRulesScript = null;

      function injectRulesCode(code) {
        // Remove previous injected rules
        clearInjectedRules();

        try {
          // Create a script element with the rules code
          injectedRulesScript = document.createElement('script');
          injectedRulesScript.id = 'event-editor-rules';
          injectedRulesScript.textContent = code;
          document.body.appendChild(injectedRulesScript);

          console.log('%c[Event Editor] Rules injected successfully', 'color: #6366f1; font-weight: bold;');
        } catch (err) {
          console.error('[Event Editor] Failed to inject rules:', err);
        }
      }

      function clearInjectedRules() {
        if (injectedRulesScript) {
          injectedRulesScript.remove();
          injectedRulesScript = null;
          console.log('%c[Event Editor] Rules cleared', 'color: #f59e0b; font-weight: bold;');
        }
      }

      // =========================================================================
      // Button Events
      // =========================================================================

      document.querySelectorAll('sg-button').forEach(btn => {
        btn.addEventListener('sgClick', e => {
          const output = document.getElementById('button-output');
          const id = btn.id || 'unknown';
          const variant = btn.getAttribute('variant') || 'default';

          output.textContent = `‚ú® Click en: ${id} (variant: ${variant})`;
          output.classList.add('highlight');
          setTimeout(() => output.classList.remove('highlight'), 500);

          notifyEventEditor('component-event', {
            event: 'sgClick',
            component: 'sg-button',
            detail: { id, variant },
          });
        });
      });

      // =========================================================================
      // Dropdown Events
      // =========================================================================

      const dropdown = document.getElementById('dropdown-menu');
      const dropdownOutput = document.getElementById('dropdown-output');

      dropdown?.addEventListener('sgOpen', () => {
        dropdownOutput.textContent = 'üìÇ Dropdown abierto';
        dropdownOutput.classList.add('highlight');
        setTimeout(() => dropdownOutput.classList.remove('highlight'), 500);

        notifyEventEditor('component-event', {
          event: 'sgOpen',
          component: 'sg-dropdown',
          detail: { id: 'dropdown-menu' },
        });
      });

      dropdown?.addEventListener('sgClose', () => {
        dropdownOutput.textContent = 'üìÅ Dropdown cerrado';

        notifyEventEditor('component-event', {
          event: 'sgClose',
          component: 'sg-dropdown',
          detail: { id: 'dropdown-menu' },
        });
      });

      // =========================================================================
      // Modal Events
      // =========================================================================

      const demoModal = document.getElementById('demo-modal');
      const confirmModal = document.getElementById('confirm-modal');
      const modalOutput = document.getElementById('modal-output');

      document.getElementById('open-modal-btn')?.addEventListener('sgClick', () => {
        demoModal?.showModal();
      });

      document.getElementById('open-modal-confirm')?.addEventListener('sgClick', () => {
        confirmModal?.showModal();
      });

      [demoModal, confirmModal].forEach(modal => {
        modal?.addEventListener('sgOpen', () => {
          modalOutput.textContent = `üîì Modal abierto: ${modal.id}`;
          modalOutput.classList.add('highlight');
          setTimeout(() => modalOutput.classList.remove('highlight'), 500);

          notifyEventEditor('component-event', {
            event: 'sgOpen',
            component: 'sg-modal',
            detail: { id: modal.id },
          });
        });

        modal?.addEventListener('sgClose', e => {
          const returnValue = e.detail?.returnValue || 'cancelled';
          modalOutput.textContent = `üîí Modal cerrado: ${modal.id} (valor: ${returnValue})`;

          notifyEventEditor('component-event', {
            event: 'sgClose',
            component: 'sg-modal',
            detail: { id: modal.id, returnValue },
          });
        });

        modal?.addEventListener('sgCancel', () => {
          modalOutput.textContent = `‚ùå Modal cancelado: ${modal.id}`;

          notifyEventEditor('component-event', {
            event: 'sgCancel',
            component: 'sg-modal',
            detail: { id: modal.id },
          });
        });
      });

      // =========================================================================
      // Input Events
      // =========================================================================

      const inputOutput = document.getElementById('input-output');

      document.querySelectorAll('sg-input').forEach(input => {
        input.addEventListener('sgInput', e => {
          const value = e.detail?.value || '';
          inputOutput.textContent = `‚å®Ô∏è Input: "${value}" (${input.id})`;

          notifyEventEditor('component-event', {
            event: 'sgInput',
            component: 'sg-input',
            detail: { id: input.id, value },
          });
        });

        input.addEventListener('sgFocus', () => {
          inputOutput.textContent = `üéØ Focus: ${input.id}`;
          inputOutput.classList.add('highlight');
          setTimeout(() => inputOutput.classList.remove('highlight'), 300);

          notifyEventEditor('component-event', {
            event: 'sgFocus',
            component: 'sg-input',
            detail: { id: input.id },
          });
        });

        input.addEventListener('sgBlur', () => {
          inputOutput.textContent = `üëã Blur: ${input.id}`;

          notifyEventEditor('component-event', {
            event: 'sgBlur',
            component: 'sg-input',
            detail: { id: input.id },
          });
        });
      });

      // =========================================================================
      // Theme Toggle Events
      // =========================================================================

      const themeToggle = document.getElementById('theme-toggle');
      themeToggle?.addEventListener('sgChange', e => {
        const theme = e.detail?.theme || 'light';
        document.documentElement.setAttribute('data-theme', theme);

        notifyEventEditor('component-event', {
          event: 'sgChange',
          component: 'sg-theme-toggle',
          detail: { theme },
        });
      });

      // =========================================================================
      // Initial setup
      // =========================================================================

      // Notify that demo is ready
      notifyEventEditor('demo-ready', { framework: 'vanilla' });
    </script>
  </body>
</html>
